<!DOCTYPE html>
<html>
    <head>
        <title>coven</title>

        <!-- <link rel="stylesheet" href="./index.css" /> -->

        <style>
            body {
                height: 100vh;
                margin: 0px;
            }

            #root {
                display: flex;
                flex-direction: row;
                width: 100%;
                height: 100%;
            }

            #graph {
                flex: 1;
            }

            .node {
                width: 200px;
                height: 100px;
                background-color: rgba(230, 230, 230);
                position: fixed;
                z-index: 1;
                white-space: pre-line;
                overflow: hidden;
            }

            .path {
                position: fixed;
                background-color: black;
                transform-origin: 0% 50%;
                height: 3px;
                z-index: 0;
            }

            #editor {
                width: 600px;
                flex-direction: column;
                display: flex;
                padding: 2px;
            }

            #author {
                border: none;
                resize: none;
                font-weight: bold;
            }

            #body {
                width: 100%;
                box-sizing: border-box;
                display: flex;
                border: none;
                resize: none;
                margin: 0px;
            }

            #body:focus {
                border: none;
                outline: none;
            }

            .box {
                margin: 2px;
                padding: 10px;
                border: 2px solid black;
            }

            .button {
                margin: 2px;
                padding: 10px;
                text-align: center;
                border: 2px solid black;
            }
        </style>
    </head>
    <body>
        <div id="root">
            <div id="graph">
            </div>
            <div id="editor">
                <div class="button" onclick="goToParent()">GO TO PARENT</div>

                <div class="box">
                    <input id="author" />
                    <textarea id="body"></textarea>
                </div>

                <span class="button" onclick="addResponse()">ADD RESPONSE</span>
            </div>
        </div>
    
        <script>
            let nodes = [
                {
                    id: 0,
                    author: "Vincent",
                    text: "",
                    paths: [],
                    x: 10,
                    y: 10
                }
            ]

            const graph = document.querySelector("#graph")

            function goToParent() {
                for (const node of nodes) {
                    if (node.paths.includes(nodes[selected].id)) {
                        return select(node)
                    }
                }
            }

            function addResponse() {
                let node = nodes[selected]
                let new_id = nodes.length

                console.log(Math.max(node.paths.map(id => nodes[id].x + 225)))

                nodes.push({
                    id: new_id,
                    author: "Vincent",
                    text: "",
                    paths: [],
                    x: Math.max(...node.paths.map(id => nodes[id].x + 225), node.x),
                    y: node.y + 125
                })

                node.paths.push(new_id)

                select(nodes[new_id])
            }

            function* draw() {
                for (const node of nodes) {
                    yield NodeView({
                        node,
                    })

                    for (let path of node.paths) {
                        yield PathView({
                            a: node,
                            b: nodes[path]
                        })
                    }
                }
            }

            let selected = 0;

            const NODE_WIDTH = 200
            const NODE_HEIGHT = 100

            function angle(x1, y1, x2, y2) {
                return Math.atan2(y2 - y1, x2 - x1)
            }

            function dist(x1, y1, x2, y2) {
                return Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2)
            }

            function PathView({ a, b }) {
                const view = document.createElement("div")

                view.className = "path"

                let x1 = a.x + NODE_WIDTH / 2
                let y1 = a.y + NODE_HEIGHT - 3

                let x2 = b.x + NODE_WIDTH / 2
                let y2 = b.y

                view.style.top = `${y1}px`

                view.style.left = `${x1}px`
                view.style.width = `${dist(x1, y1, x2, y2)}px`

                view.style.transform = `rotate(${angle(x1, y1, x2, y2)}rad)`

                view.style.path = `path()`

                return view
            }

            function select(node) {
                selected = node.id

                document.getElementById("author").value = node.author
                document.getElementById("body").value = node.text

                // expand it
                bodyView.style.height = "0px"
                bodyView.style.height = bodyView.scrollHeight + "px"

                update()
            }

            const bodyView = document.getElementById("body");
            bodyView.oninput = (e) => {
                // save the new value
                nodes[selected].text = bodyView.value

                // expand it
                bodyView.style.height = "0px"
                bodyView.style.height = bodyView.scrollHeight + "px"

                // update
                update()
            }

            document.getElementById("author").oninput = (e) => {
                nodes[selected].author = document.getElementById("author").value
                update()
            }

            function NodeView({ node }) {
                const view = document.createElement("div")

                view.className = "node"
                view.innerHTML = `<b>${node.author}</b>\n${node.text}`

                view.style.left = `${node.x}px`
                view.style.top = `${node.y}px`
                view.style.border = selected == node.id ? '1px blue solid' : 'none'

                view.onmousedown = (e) => {
                    mouse.isDown = true

                    let ox = node.x - e.x
                    let oy = node.y - e.y

                    mouse.onmove = (e) => {
                        node.x = e.x + ox
                        node.y = e.y + oy
                        update()
                    }

                    mouse.ondone = (e) => {
                    }

                    mouse.onclick = (e) => {
                        select(node)
                    }
                }

                return view
            }

            function update() {
                graph.replaceChildren(...draw())
            }

            const mouse = {}

            graph.onmousemove = (e) => {
                if (mouse.isDown) {
                    mouse.isDrag = true
                    mouse.onmove(e)
                }
            }

            graph.onmouseup = (e) => {
                if (mouse.isDown) {
                    if (mouse.isDrag) {
                        mouse.ondone(e)
                    } else {
                        mouse.onclick(e)
                    }

                    Object.keys(mouse).forEach(key => delete mouse[key]);
                    
                    update()
                }
            }

            select(nodes[0])
            update()
        </script>
    </body>
</html>